---
import Icon from "@/components/misc/Icon.astro";
import BangumiSection from "@/components/pages/bangumi/BangumiSection.astro";
import BilibiliSection from "@/components/pages/bangumi/BilibiliSection.astro";
import TabNav from "@/components/pages/bangumi/TabNav.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import type {
	UserSubjectCollection,
	UserSubjectCollectionResponse,
} from "@/types/bangumi";
import type { BiliSeasonItem, BilibiliFollowListResponse } from "@/types/bilibili";

//å‚è€ƒï¼šéœè‘‰ https://kasuha.com/posts/fuwari-enhance-ep2/

// æ£€æŸ¥é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.pages.bangumi) {
	return Astro.redirect("/404/");
}

//////////////// Bangumi é…ç½® ////////////////////////
const bangumiConfig = {
	username: siteConfig.bangumi?.userId, // åœ¨è¿™é‡Œé…ç½®ä½ çš„Bangumiç”¨æˆ·å
	apiUrl: "https://api.bgm.tv",
	categories: {
		book: false,
		anime: true,
		music: false,
		game: true,
		real: false,
	},
	// æ•°æ®è·å–è®¾ç½®
	pagination: {
		limit: 50, // æ¯é¡µè·å–æ•°é‡
		delay: 50, // è¯·æ±‚é—´éš”æ¯«ç§’æ•°ï¼Œé¿å…é¢‘ç‡é™åˆ¶
		maxTotal: 1000, // æœ€å¤§è·å–æ€»æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯ï¼ˆ0=æ— é™åˆ¶ï¼‰
	},
};
////////////////////////////////////////////////////

// æ•°æ®æºï¼šBangumi æˆ– Bilibili
const dataSource = siteConfig.bangumiSource ?? "bangumi";

// åˆ†ç±»æ˜ å°„
const categoryMap = {
	book: { id: "book", name: i18n(I18nKey.bangumiCategoryBook), subjectType: 1 },
	anime: {
		id: "anime",
		name: i18n(I18nKey.bangumiCategoryAnime),
		subjectType: 2,
	},
	music: {
		id: "music",
		name: i18n(I18nKey.bangumiCategoryMusic),
		subjectType: 3,
	},
	game: { id: "game", name: i18n(I18nKey.bangumiCategoryGame), subjectType: 4 },
	real: { id: "real", name: i18n(I18nKey.bangumiCategoryReal), subjectType: 6 },
};

// è·å–Bangumiæ•°æ®çš„å‡½æ•° - æ”¯æŒåˆ†é¡µè·å–æ‰€æœ‰æ•°æ®
async function fetchBangumiData(username: string, subjectType: number) {
	try {
		const { limit, delay, maxTotal } = bangumiConfig.pagination;
		let offset = 0;
		let allData: UserSubjectCollection[] = [];
		let hasMore = true;

		// å¼€å‘æ¨¡å¼ä¸‹åªè·å–ä¸€é¡µæ•°æ®ï¼ŒåŠ å¿«è°ƒè¯•é€Ÿåº¦
		const isDev = import.meta.env.DEV;
		const maxPages = isDev ? 1 : 0; // 0 è¡¨ç¤ºä¸é™åˆ¶

		console.log(
			`[Bangumi] ${isDev ? "ğŸ”§ å¼€å‘æ¨¡å¼" : "ğŸŒ ç”Ÿäº§æ¨¡å¼"} - å¼€å§‹è·å–ç”¨æˆ· ${username} çš„ subjectType ${subjectType} æ•°æ®...`,
		);

		while (hasMore) {
			// å¼€å‘æ¨¡å¼é™åˆ¶ï¼šåªè·å–ä¸€é¡µ
			if (isDev && maxPages > 0 && allData.length >= limit * maxPages) {
				console.log(`[Bangumi] å¼€å‘æ¨¡å¼ï¼šå·²è·å– ${maxPages} é¡µæ•°æ®ï¼Œåœæ­¢è·å–`);
				break;
			}

			// æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§è·å–é™åˆ¶
			if (maxTotal > 0 && allData.length >= maxTotal) {
				console.log(`[Bangumi] å·²è¾¾åˆ°æœ€å¤§è·å–é™åˆ¶ ${maxTotal}ï¼Œåœæ­¢è·å–`);
				break;
			}

			const url = `${bangumiConfig.apiUrl}/v0/users/${username}/collections?subject_type=${subjectType}&limit=${limit}&offset=${offset}`;

			console.log(`[Bangumi] æ­£åœ¨è·å–æ•°æ®: ${url} (å·²è·å–: ${allData.length})`);

			const response = await fetch(url, {
				headers: {
					"User-Agent": "YuuOuRou Blog",
					Accept: "application/json",
				},
			});

			if (!response.ok) {
				console.warn(
					`[Bangumi] æ— æ³•è·å–æ•°æ® (çŠ¶æ€ç : ${response.status}):`,
					url,
				);
				break;
			}

			const data = (await response.json()) as UserSubjectCollectionResponse;
			const currentBatch = data.data || [];

			if (currentBatch.length > 0) {
				allData = allData.concat(currentBatch);
				offset += limit;

				// å¦‚æœæœ¬æ¬¡è·å–çš„æ•°æ®å°‘äºlimitï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ
				if (currentBatch.length < limit) {
					hasMore = false;
				}
			} else {
				hasMore = false;
			}

			// æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
			if (hasMore) {
				await new Promise((resolve) => setTimeout(resolve, delay));
			}
		}

		console.log(`[Bangumi] æ€»å…±è·å–åˆ° ${allData.length} æ¡æ•°æ®`);
		return allData;
	} catch (error) {
		console.error("[Bangumi] è·å–æ•°æ®æ—¶å‡ºé”™:", error);
		return [];
	}
}

/**
 * è·å– Bilibili è¿½ç•ª/è¿½å‰§æ•°æ®ï¼ˆåˆ†é¡µï¼‰
 * @param mid Bilibili ç”¨æˆ·MID
 * @param type 1=ç•ªå‰§ï¼Œ2=å‰§é›†
 */
async function fetchBilibiliData(mid: string, type: number) {
	try {
		const { limit, delay, maxTotal } = bangumiConfig.pagination;
		let pn = 1;
		const ps = Math.min(15, limit); // Bç«™æ¥å£å¸¸ç”¨æ¯é¡µæ•°é‡ä¸º15
		let allData: BiliSeasonItem[] = [];
		let hasMore = true;
		const isDev = import.meta.env.DEV;
		const maxPages = isDev ? 1 : 0; // å¼€å‘æ¨¡å¼ä»…æ‹‰å–ä¸€é¡µ
		const envCookie = (import.meta.env as any)?.BILI_COOKIE as string | undefined;

		console.log(
			`[Bilibili] ${isDev ? "ğŸ”§ å¼€å‘æ¨¡å¼" : "ğŸŒ ç”Ÿäº§æ¨¡å¼"} - å¼€å§‹è·å–ç”¨æˆ· ${mid} çš„ type ${type} æ•°æ®...`,
		);

		while (hasMore) {
			if (isDev && maxPages > 0 && pn > maxPages) {
				console.log(`[Bilibili] å¼€å‘æ¨¡å¼ï¼šå·²è·å– ${maxPages} é¡µæ•°æ®ï¼Œåœæ­¢è·å–`);
				break;
			}

			if (maxTotal > 0 && allData.length >= maxTotal) {
				console.log(`[Bilibili] å·²è¾¾åˆ°æœ€å¤§è·å–é™åˆ¶ ${maxTotal}ï¼Œåœæ­¢è·å–`);
				break;
			}

			const url = `https://api.bilibili.com/x/space/bangumi/follow/list?vmid=${mid}&type=${type}&pn=${pn}&ps=${ps}&follow_status=0`;
			console.log(`[Bilibili] æ­£åœ¨è·å–æ•°æ®: ${url} (å·²è·å–: ${allData.length})`);

			const headers: Record<string, string> = {
				"User-Agent":
					"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0 Safari/537.36",
				Accept: "application/json",
				"Accept-Language": "zh-CN,zh;q=0.9",
				Origin: "https://space.bilibili.com",
				Referer: `https://space.bilibili.com/${mid}/bangumi`,
			};
			// å¯é€‰ï¼šæºå¸¦ç”¨æˆ·é…ç½®çš„Cookie
			if (siteConfig.bilibili?.cookie) {
				headers.Cookie = siteConfig.bilibili.cookie;
			} else if (envCookie) {
				headers.Cookie = envCookie;
			}

			const response = await fetch(url, {
				headers: {
					...headers,
				},
			});

			if (!response.ok) {
				console.warn(`[Bilibili] æ— æ³•è·å–æ•°æ® (çŠ¶æ€ç : ${response.status}):`, url);
				break;
			}

			const raw = (await response.json()) as BilibiliFollowListResponse;
			console.log(
				`[Bilibili] å“åº”ä»£ç : ${String((raw as any)?.code)}, ä¿¡æ¯: ${String((raw as any)?.message)}`,
			);
			console.log(
				`[Bilibili] å“åº”dataé”®: ${Object.keys((raw as any)?.data || {}).join(",")}`,
			);
			const currentBatch =
				(raw?.data as any)?.list ||
				(raw?.data as any)?.result ||
				(raw as any)?.result ||
				[];
			console.log(
				`[Bilibili] æœ¬é¡µè¿”å›æ¡ç›®: ${Array.isArray(currentBatch) ? currentBatch.length : 0}`,
			);

			// é¦–é¡µä¸ºç©ºæ—¶å°è¯•æ—§æ¥å£ä½œä¸ºå›é€€
			if (pn === 1 && (!Array.isArray(currentBatch) || currentBatch.length === 0)) {
				try {
					const fallbackUrl = `https://space.bilibili.com/ajax/Bangumi/getList?mid=${mid}`;
					console.log(`[Bilibili] å°è¯•å›é€€æ¥å£: ${fallbackUrl}`);
					const fbResp = await fetch(fallbackUrl, {
						headers,
					});
					if (fbResp.ok) {
						const fbJson = (await fbResp.json()) as any;
						const fbList =
							(fbJson?.data && fbJson?.data?.result) ||
							fbJson?.result ||
							[];
						if (Array.isArray(fbList) && fbList.length > 0) {
							const mapped: BiliSeasonItem[] = fbList.map((it: any) => ({
								season_id: Number(it?.season_id ?? it?.seasonId ?? 0),
								title: String(it?.title ?? ""),
								cover: String(it?.cover ?? it?.square_cover ?? ""),
								total_count: Number(it?.total_count ?? it?.total ?? 0),
								is_finish: Number(it?.is_finish ?? it?.is_finish ?? 0),
								season_type_name: String(it?.season_type_name ?? it?.type_name ?? ""),
								stat: {
									follow: Number(it?.stat?.follow ?? it?.favorites ?? 0),
								},
							}));
							console.log(`[Bilibili] å›é€€æ¥å£è·å–åˆ° ${mapped.length} æ¡æ•°æ®`);
							allData = allData.concat(mapped);
							hasMore = false;
							break;
						}
					} else {
						console.warn(
							`[Bilibili] å›é€€æ¥å£å¤±è´¥ (çŠ¶æ€ç : ${fbResp.status}):`,
							fallbackUrl,
						);
					}
				} catch (fbErr) {
					console.warn("[Bilibili] å›é€€æ¥å£å¼‚å¸¸:", fbErr);
				}
			}

			if (currentBatch.length > 0) {
				allData = allData.concat(currentBatch);
				pn += 1;
				// å¦‚æœè¿”å›æ•°é‡å°‘äºè¯·æ±‚çš„limitï¼Œè§†ä¸ºæœ€åä¸€é¡µ
				if (currentBatch.length < ps) {
					hasMore = false;
				}
			} else {
				hasMore = false;
			}

			if (hasMore) {
				await new Promise((resolve) => setTimeout(resolve, delay));
			}
		}

		console.log(`[Bilibili] æ€»å…±è·å–åˆ° ${allData.length} æ¡æ•°æ®`);
		return allData;
	} catch (error) {
		console.error("[Bilibili] è·å–æ•°æ®æ—¶å‡ºé”™:", error);
		return [];
	}
}

// è·å–æ‰€æœ‰å¯ç”¨åˆ†ç±»çš„æ•°æ®
const bangumiData: Record<string, UserSubjectCollection[]> = {};
const biliData: Record<string, BiliSeasonItem[]> = {};
const tabs: Array<{ id: string; name: string; count: number }> = [];

// æ ¹æ®æ•°æ®æºæ£€æŸ¥é…ç½®çŠ¶æ€
const isBangumiUserIdConfigured =
	bangumiConfig.username &&
	bangumiConfig.username !== "you-user-id" &&
	bangumiConfig.username.trim() !== "";
const biliUserId = siteConfig.bilibili?.userId;
const isBiliUserIdConfigured =
	biliUserId &&
	biliUserId !== "your-bilibili-mid" &&
	biliUserId.trim() !== "";

if (dataSource === "bangumi") {
	if (!isBangumiUserIdConfigured) {
		console.log("[Bangumi] âš ï¸ æœªé…ç½® Bangumi ç”¨æˆ·IDï¼Œè·³è¿‡æ•°æ®è·å–");
	} else {
		console.log("[Bangumi] ğŸŒ ä» API è·å–æ•°æ®");
	}
} else {
	if (!isBiliUserIdConfigured) {
		console.log("[Bilibili] âš ï¸ æœªé…ç½® Bilibili ç”¨æˆ·MIDï¼Œè·³è¿‡æ•°æ®è·å–");
	} else {
		console.log("[Bilibili] ğŸŒ ä» API è·å–æ•°æ®");
	}
}

if (dataSource === "bangumi") {
	for (const [categoryKey, enabled] of Object.entries(bangumiConfig.categories)) {
		// å¦‚æœæœªé…ç½®ç”¨æˆ·IDï¼Œè·³è¿‡æ•°æ®è·å–
		if (!isBangumiUserIdConfigured) {
			break;
		}
		if (enabled && categoryMap[categoryKey as keyof typeof categoryMap]) {
			const categoryInfo = categoryMap[categoryKey as keyof typeof categoryMap];
			try {
				const data = await fetchBangumiData(
					// biome-ignore lint/style/noNonNullAssertion: Checked by isBangumiUserIdConfigured
					bangumiConfig.username!,
					categoryInfo.subjectType,
				);
				bangumiData[categoryKey] = data;
				tabs.push({
					id: categoryKey,
					name: categoryInfo.name,
					count: data.length,
				});
			} catch (error) {
				console.error(`[Bangumi] è·å– ${categoryInfo.name} æ•°æ®å¤±è´¥:`, error);
				bangumiData[categoryKey] = [];
				tabs.push({
					id: categoryKey,
					name: categoryInfo.name,
					count: 0,
				});
			}
		}
	}
} else {
	// Bilibili åˆ†ç±»ï¼šç•ªå‰§/å‰§é›†
	const biliCategories = {
		anime: { id: "anime", name: "ç•ªå‰§", type: 1 },
		drama: { id: "drama", name: "å‰§é›†", type: 2 },
	} as const;
	// å¦‚æœæœªé…ç½®ç”¨æˆ·MIDï¼Œè·³è¿‡æ•°æ®è·å–
	if (isBiliUserIdConfigured) {
		for (const [, categoryInfo] of Object.entries(biliCategories)) {
			try {
				const data = await fetchBilibiliData(
					// biome-ignore lint/style/noNonNullAssertion: Checked by isBiliUserIdConfigured
					biliUserId!,
					categoryInfo.type,
				);
				biliData[categoryInfo.id] = data;
				tabs.push({
					id: categoryInfo.id,
					name: categoryInfo.name,
					count: data.length,
				});
			} catch (error) {
				console.error(`[Bilibili] è·å– ${categoryInfo.name} æ•°æ®å¤±è´¥:`, error);
				biliData[categoryInfo.id] = [];
				tabs.push({
					id: categoryInfo.id,
					name: categoryInfo.name,
					count: 0,
				});
			}
		}
	}
}

const activeTab = tabs[0]?.id || "anime";

// è·å–æ„å»ºæ—¶é—´
const buildTime = new Date().toLocaleString();
---

<MainGridLayout title={i18n(I18nKey.bangumi)} description={i18n(I18nKey.bangumiSubtitle)}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="relative w-full mb-8">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70">
                        <Icon icon="material-symbols:movie" class="text-[1.5rem]"></Icon>
                    </div>
                    <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
                        {i18n(I18nKey.bangumi)}
                    </h1>
                </div>
                <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed">
                    {i18n(I18nKey.bangumiSubtitle)}
                </p>
                <p class="text-xs text-neutral-500 dark:text-neutral-500 mt-2">
                    {i18n(I18nKey.bangumiLastUpdated)} {buildTime}
                </p>
            </div>

      <!-- Tab å¯¼èˆªå’Œå†…å®¹ -->
      {tabs.length > 0 ? (
        <>
          <TabNav tabs={tabs} activeTab={activeTab} />

          <!-- å†…å®¹åŒºåŸŸ -->
          {tabs.map((tab) => (
            <>
              {dataSource === "bangumi" ? (
                <BangumiSection
                  sectionId={tab.id}
                  items={bangumiData[tab.id] || []}
                  isActive={tab.id === activeTab}
                  itemsPerPage={6}
                />
              ) : (
                <BilibiliSection
                  sectionId={tab.id}
                  items={biliData[tab.id] || []}
                  isActive={tab.id === activeTab}
                  itemsPerPage={6}
                />
              )}
            </>
          ))}
        </>
      ) : (
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-[var(--btn-regular-bg)] rounded-full mb-6 border border-[var(--line-divider)]">
            <Icon icon="material-symbols:settings" class="text-[2rem] text-[var(--btn-content)]" />
          </div>
          <h2 class="text-xl font-semibold text-black/80 dark:text-white/80 mb-3">
            {dataSource === "bangumi"
              ? (isBangumiUserIdConfigured ? i18n(I18nKey.bangumiEmpty) : "æœªé…ç½® Bangumi ç”¨æˆ·ID")
              : (isBiliUserIdConfigured ? "æš‚æ— æ•°æ®" : "æœªé…ç½® Bilibili ç”¨æˆ·MID")}
          </h2>
          <p class="text-black/60 dark:text-white/60 mb-4 max-w-md mx-auto">
            {dataSource === "bangumi"
              ? (isBangumiUserIdConfigured ? i18n(I18nKey.bangumiEmptyReason) : "è¯·åœ¨ src/config/siteConfig.ts ä¸­é…ç½®ä½ çš„ Bangumi ç”¨æˆ·ID")
              : (isBiliUserIdConfigured ? "æ‹‰å–å¤±è´¥æˆ–æš‚æ— æ¡ç›®" : "è¯·åœ¨ src/config/siteConfig.ts ä¸­é…ç½®ä½ çš„ Bilibili ç”¨æˆ·MID")}
          </p>
        </div>
      )}
    </div>
  </div>
</MainGridLayout>

<style>
  /* è‡ªå®šä¹‰æ ·å¼ */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
